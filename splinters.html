<title>splinters</title>
<link rel="icon" href="icon.png">
<style>
  body {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    image-rendering: pixelated;
    background: black;
  }

  div {
    width: 100%;
    height: 100%;
    position: absolute;
    mix-blend-mode: difference;
  }

  #loader {
    width: 25vw;
    height: 25vw;
    border-radius: 50%;
    border-style: solid;
    animation: border 3s linear infinite, hue 8s linear infinite;
  }

  @keyframes border {
      0% { border-width: 16px  0px  0px  0px; }
     25% { border-width:  0px 16px  0px  0px; }
     50% { border-width:  0px  0px 16px  0px; }
     75% { border-width:  0px  0px  0px 16px; }
    100% { border-width: 16px  0px  0px  0px; }
  }

  @keyframes hue {
      0% { border-color: hsl(  0, 100%, 50%); }
     25% { border-color: hsl( 90, 100%, 50%); }
     50% { border-color: hsl(180, 100%, 50%); }
     75% { border-color: hsl(270, 100%, 50%); }
    100% { border-color: hsl(360, 100%, 50%); }
  }
</style>

<body>
  <div id="loader"></div>
</body>

<script type="module">
  const randomFloat   = (min = 0, max = 1) =>            Math.random() * (max - min)      + min
  const randomInteger = (min = 0, max = 1) => Math.floor(Math.random() * (max - min + 1)) + min

  const shuffle = array => {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [ array[i], array[j] ] = [ array[j], array[i] ];
    }
  }

  const load = path => new Promise(resolve => {
    const image = new Image();
    image.onload = () => resolve(image)
    image.src = path;
  })

  const paths = [
    '18fc4d371f750aa77e20206081ac1fb3',
    'a-brief-interlude-of-self-loathing',
    'at-fence',
    'b5e685e242618f2b7c32f696a829e114',
    'be-not-afraid-my-servant-jacob',
    'brittle-in-the-blackened-trees',
    'chelsea',
    'ding',
    'e7c75f69dbb08f4a4bc05e44305d1786',
    'fencate',
    'hame',
    'i-have-been-illegally-transformed-into-a-yellow-flower',
    'i-hear-my-footsteps-running-after-me-but-i-am-already-gone',
    'i-love-you-into-the-sea',
    'i-wish-i-could-breathe-like-you',
    'if-you-please-we-will-commit-ourselves-to-this-void',
    'jordans-pocket',
    'noises-i-made-without-using-my-vocal-cords',
    'please-make-those-annoying-sounds-quieter-or-turn-them-off',
    'teleonomy',
    'the-harvest-is-past-the-summer-is-ended',
    'total-emotional-collapse-number-four',
    'tunafish-sandwich-piece',
    'with-the-great-unconscious-gravity-of-a-girl',
  ].map(file => `files/spectrograms/${file}.png`);

  const images = await Promise.all(paths.map(load));

  loader.remove();

  const layers = images.map(({ src, width, height }) => {
    const { style } = document.body.appendChild(document.createElement('div'));
    const range     = {};

    const delays = {
      properties : {},

      update() {
        style.transition = Object.entries(this.properties)
        .map(([ property, delay ]) => `${property} ${delay / 1000}s`).join(', ');
      },

      set    zoom(t) { this.properties[ 'background-size'     ] = t; this.update() },
      set    move(t) { this.properties[ 'background-position' ] = t; this.update() },
      set     hue(t) { this.properties[ 'filter'              ] = t; this.update() },
      set opacity(t) { this.properties[ 'opacity'             ] = t; this.update() },
    };

    const position = ({ x, y }) => style.backgroundPosition = [ x, y ]
    .map(n => `${n}px`).join(' ')

    const zoom = () => {
      const scale    = randomFloat(0.1, 5);
      const [ x, y ] = [ width, height ].map(n => n * scale);

      range.x = x - innerWidth;
      range.y = y - innerHeight;

      const delay = randomInteger(2000, 8000);
      delays.zoom = delay / 4;
      style.backgroundSize = [ width, height ].map(n => `${n}px`).join(' ');
      setTimeout(zoom, delay);
    }

    const move = () => {
      if (! style.backgroundPosition) {
        const [ x, y ] = [ range.x, range.y ].map(n => randomInteger(0, -n));

        position({ x, y });
        setTimeout(move, 100);
      } else {
        const [ x, y ] = style.backgroundPosition.split(' ').map(n => parseInt(n));

        const from = { x, y };
        const to   = { x, y };

        const axis = Math.random() < 0.5 ? 'x' : 'y';
        to[axis] = randomInteger(0, -range[axis]);

        const delay = Math.abs(to[axis] - from[axis]) * 8;
        delays.move = delay;
        position(to);
        setTimeout(move, delay);
      }
    }

    const index = () => {
      const delay = randomInteger(2000, 8000);
      style.zIndex = randomInteger(0, 8);
      setTimeout(index, delay);
    }

    const hue = () => {
      const delay = randomInteger(2000, 8000);
      delays.hue = delay;
      style.filter = `hue-rotate(${randomInteger(0, 360)}deg)`;
      setTimeout(hue, delay);
    }

    style.backgroundImage = `url(${src})`;

    zoom();
    move();
    index();
    hue();

    return { style, delays };
  });

  const opacity = () => {
    const delay   = randomInteger(2000, 8000);
    const visible = randomInteger(3, 6);

    shuffle(layers);

    layers.forEach(({ style, delays }, i) => {
      delays.opacity = delay / 4;
      style.opacity  = i < visible ? 1 : 0;
    });

    setTimeout(opacity, delay);
  }

  opacity();
</script>